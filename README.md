# Домашнее задание 3 конфигурационное управление
## Вариант 31
### Задание 3

## Ассемблер и интерпретатор для учебной виртуальной машины (УВМ)

## Описание задачи
Разработать ассемблер и интерпретатор для учебной виртуальной машины (УВМ). 

### Система команд УВМ
Для ассемблера необходимо разработать удобное и читаемое представление команд УВМ.

- Ассемблер принимает на вход файл с текстом исходной программы. Путь к файлу задается через аргументы командной строки.  
- Результат работы ассемблера — бинарный файл в виде последовательности байт, путь к которому также задается через командную строку.  
- Дополнительно можно указать путь к **файлу-логу**, где хранятся ассемблированные инструкции в формате “ключ=значение” (пример в тестах ниже).  

**Интерпретатор**:
- Принимает на вход бинарный файл.  
- Выполняет команды УВМ.  
- Сохраняет значения из заданного диапазона памяти УВМ в **файле-результате**.  
- Диапазон памяти указывается через командную строку.  

**Формат файлов**:
- Лог-файл и файл-результата используют формат **YAML**.  

Необходимо реализовать приведенные тесты для всех команд и разработать собственную тестовую программу.

---

## Команды УВМ

### Загрузка константы
| Поле  | Биты       | Описание           |
|-------|------------|--------------------|
| `A`   | 0—4        | Код операции (26) |
| `B`   | 5—23       | Константа         |
| `C`   | 24—27      | Адрес             |

- **Размер команды**: 4 байта.  
- **Операнд**: Константа (поле `B`).  
- **Результат**: Регистр по адресу из поля `C`.  

**Тест** (A=26, B=469, C=11):  
`0xBA, 0x3A, 0x00, 0x0B`

---

### Чтение из памяти
| Поле  | Биты       | Описание           |
|-------|------------|--------------------|
| `A`   | 0—4        | Код операции (13) |
| `B`   | 5—8        | Адрес             |
| `C`   | 9—12       | Адрес             |

- **Размер команды**: 2 байта.  
- **Операнд**: Ячейка памяти по адресу, указанному в регистре из поля `B`.  
- **Результат**: Регистр по адресу из поля `C`.  

**Тест** (A=13, B=3, C=8):  
`0x6D, 0x10`

---

### Запись в память
| Поле  | Биты       | Описание           |
|-------|------------|--------------------|
| `A`   | 0—4        | Код операции (31) |
| `B`   | 5—19       | Адрес             |
| `C`   | 20—23      | Адрес             |

- **Размер команды**: 3 байта.  
- **Операнд**: Регистр по адресу из поля `C`.  
- **Результат**: Ячейка памяти по адресу из поля `B`.  

**Тест** (A=31, B=326, C=3):  
`0xDF, 0x28, 0x30`

---

### Унарная операция: sqrt()
| Поле  | Биты       | Описание           |
|-------|------------|--------------------|
| `A`   | 0—4        | Код операции (24) |
| `B`   | 5—8        | Адрес             |
| `C`   | 9—12       | Адрес             |

- **Размер команды**: 2 байта.  
- **Операнд**: Ячейка памяти по адресу, указанному в регистре из поля `C`.  
- **Результат**: Ячейка памяти по адресу, указанному в регистре из поля `B`.  

**Тест** (A=24, B=1, C=2):  
`0x38, 0x04`

---

## Тестовая программа
**Задача**:  
Выполнить поэлементно операцию `sqrt()` над вектором длины 7. Результат записать в новый вектор.

---

# Общее описание
## Ассемблер для УВМ

Данный код реализует ассемблер для преобразования текстового описания инструкций (в файле `.asm`) в бинарный файл и создания файла логов в формате YAML.

### Основные функции
1. **Чтение входного файла**:  
   Обрабатывает текстовый файл с инструкциями, разделяет команды и их параметры.

2. **Преобразование в бинарный файл**:  
   Каждая команда преобразуется в соответствующую последовательность байт на основе словаря команд `command_dict`.

3. **Логирование данных**:  
   Логи команд (включая их параметры) записываются в файл в формате YAML.

### Поддерживаемые команды
- **`load_constant`**: Загрузка константы.  
- **`read_memory`**: Чтение из памяти.  
- **`write_memory`**: Запись в память.  
- **`sqrt`**: Унарная операция извлечения квадратного корня.

### Используемые технологии
- **`struct`**: Для упаковки данных в бинарном формате.  
- **`sys`**: Для работы с аргументами командной строки.  
- **`yaml`**: Для создания логов в формате YAML.

### Пример использования
```bash
python assembler.py input.asm output.bin log.yaml
```

- `input.asm` — входной файл с текстом инструкций.  
- `output.bin` — выходной бинарный файл.  
- `log.yaml` — файл логов в формате YAML.


## Интерпретатор для УВМ

Код реализует интерпретатор, который выполняет команды виртуальной машины, загруженные из бинарного файла, и сохраняет состояние памяти в файл YAML.

### Основные функции
1. **Чтение бинарного файла**:  
   Интерпретатор загружает бинарный код программы, представляющий команды УВМ.

2. **Выполнение команд**:  
   Поддерживаются следующие операции:
   - `load_constant`: загрузка значения в память.
   - `sqrt`: вычисление квадратного корня.
   - `read_memory`: чтение данных из памяти.
   - `write_memory`: запись данных в память.

3. **Сохранение результата**:  
   Измененное состояние памяти записывается в YAML-файл, игнорируя неизмененные ячейки.

### Пример использования
```bash
python interpreter.py program.bin result.yaml
```

- `program.bin` — бинарный файл с командами для выполнения.  
- `result.yaml` — файл, куда сохраняется итоговое состояние памяти.

---

# Описание функции assemble_program
Функция `assemble_program` принимает текстовый файл с инструкциями виртуальной машины, преобразует его в бинарный файл с командами и сохраняет логи в YAML-файл. Каждая строка исходного файла анализируется на наличие инструкций и параметров. Команды распознаются и преобразуются в соответствующий двоичный формат с учетом заданной структуры (например, код операции и параметры).  

Для каждой команды:  
- Параметры команды извлекаются и упаковываются в бинарный формат.  
- Создается запись в логах, содержащая информацию о команде, ее параметрах и бинарном представлении.  

Результаты:
1. Бинарный файл — содержит последовательность байт, готовых для интерпретации виртуальной машиной.  
2. YAML-файл — структурированный лог с детализацией команд и их параметров.

---

# Описание функции execute_program
Функция `execute_program` выполняет интерпретацию бинарного файла с инструкциями виртуальной машины (УВМ).  

1. **Инициализация**: Создается массив памяти из 128 ячеек, и содержимое бинарного файла считывается в переменную `program`.  

2. **Исполнение инструкций**:  
   - Считывается текущая команда (opcode) и соответствующие параметры.  
   - На основе кода операции выполняются действия:  
     - **load_constant**: записывает значение в указанный адрес памяти.  
     - **sqrt**: вычисляет квадратный корень значения из памяти и сохраняет результат.  
     - **read_memory**: копирует значение из одной ячейки памяти в другую.  
     - **write_memory**: записывает значение из памяти по одному адресу в другой.  
   - Программный счетчик (`pc`) обновляется для перехода к следующей команде.  

3. **Результат**:  
   После выполнения всех команд измененное состояние памяти сохраняется в выходной файл в формате YAML.

---

# Описание функции write_memory_to_yaml
Функция `write_memory_to_yaml` сохраняет измененные ячейки памяти в файл в формате YAML.  

1. **Фильтрация памяти**: Из массива памяти выбираются только ненулевые значения, представляющие измененные ячейки.  
2. **Запись в файл**: Создается YAML-файл, где отфильтрованные данные записываются в виде словаря с ключом `'memory'`.

---

# Тест
![Тест](https://raw.githubusercontent.com/juliyurkova/conf_man4/refs/heads/main/1.bmp)
![Тест](https://raw.githubusercontent.com/juliyurkova/conf_man4/refs/heads/main/2.bmp)
![Тест](https://raw.githubusercontent.com/juliyurkova/conf_man4/refs/heads/main/3.bmp)
